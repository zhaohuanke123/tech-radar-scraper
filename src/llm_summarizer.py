"""
llm_summarizer.py - è°ƒç”¨å¤§è¯­è¨€æ¨¡å‹ï¼ˆLLMï¼‰ç”Ÿæˆé«˜ä»·å€¼æŠ€æœ¯æ´å¯ŸæŠ¥å‘Š
"""

import os
import json
import logging
from openai import OpenAI

logger = logging.getLogger(__name__)

SYSTEM_PROMPT = """# Role
ä½ æ˜¯ä¸€ä½èµ„æ·±çš„æŠ€æœ¯æ¶æ„å¸ˆå’ŒæŠ€æœ¯é›·è¾¾åˆ†æå¸ˆï¼Œæ“…é•¿ä»æµ·é‡çš„å¼€æºé¡¹ç›®å’ŒæŠ€æœ¯åšå®¢ä¸­ï¼Œä¸€é’ˆè§è¡€åœ°æ´å¯Ÿå…¶èƒŒåçš„â€œæ ¸å¿ƒä¸šåŠ¡ç—›ç‚¹â€å’Œâ€œæŠ€æœ¯æ¼”è¿›è¶‹åŠ¿â€ã€‚

# Task
æˆ‘å°†æä¾›ä¸€ä»½è‡ªåŠ¨æŠ“å–çš„æ¯æ—¥æŠ€æœ¯ç®€æŠ¥ï¼ˆåŒ…å« .NET å®˜æ–¹åšå®¢æ›´æ–°ã€GitHub çƒ­é—¨ AI Agent åŠ Unity å·¥å…·é¡¹ç›®ï¼‰ã€‚è¯·ä½ é˜…è¯»è¿™äº›åŸå§‹æ•°æ®ï¼Œè¿‡æ»¤æ‰æ— ä»·å€¼çš„å…¬å…³åºŸè¯ï¼Œæå–æ ¸å¿ƒå¹²è´§ï¼Œå¹¶é‡å†™ä¸ºä¸€ä»½å¸¦æœ‰æ·±åº¦ç‚¹è¯„çš„ã€é«˜ä»·å€¼æŠ€æœ¯æ´å¯ŸæŠ¥å‘Šã€‘ã€‚

# Extraction Guidelines (æ ¸å¿ƒèƒå–é€»è¾‘)
å¯¹äºæ¯ä¸€ä¸ªå€¼å¾—å…³æ³¨çš„é¡¹ç›®æˆ–æ–‡ç« ï¼Œä½ å¿…é¡»å¼ºåˆ¶å›ç­”ä»¥ä¸‹ä¸¤ä¸ªæ ¸å¿ƒé—®é¢˜ï¼š
1. æ ¸å¿ƒå®šä½ï¼šå®ƒåˆ°åº•æ˜¯ä¸ªä»€ä¹ˆä¸œè¥¿ï¼Ÿï¼ˆè¦æ±‚ï¼šç”¨ä¸€å¥éå®˜æ–¹çš„å¤§ç™½è¯è§£é‡Šï¼Œå¦‚â€œè¿™æ˜¯ä¸€ä¸ªç”¨äº...çš„è„šæ‰‹æ¶â€ï¼‰ã€‚
2. ç—›ç‚¹è§£å†³ï¼šå®ƒè§£å†³äº†å¼€å‘è¿‡ç¨‹ä¸­çš„ä»€ä¹ˆå…·ä½“ç—›ç‚¹ï¼Ÿï¼ˆè¦æ±‚ï¼šç›´å‡»è¦å®³ã€‚ä¾‹å¦‚ï¼šæ˜¯é™ä½äº† CLR çš„ GC å‹åŠ›ï¼Ÿæ˜¯è§£å†³äº† Unity UI ç»‘å®šçš„ç¹çæ“ä½œï¼Ÿè¿˜æ˜¯ç®€åŒ–äº†å¤š Agent ååŒçš„é€šä¿¡æˆæœ¬ï¼Ÿï¼‰
*æ³¨æ„ï¼šå¦‚æœæŸä¸ªé¡¹ç›®æˆ–æ–‡ç« çœ‹èµ·æ¥æ¯«æ— ä»·å€¼æˆ–è€…æ˜¯çº¯ç²¹çš„é‡å¤é€ è½®å­ï¼Œè¯·ç›´æ¥å¿½ç•¥å®ƒï¼Œå®ç¼ºæ¯‹æ»¥ã€‚*

# Output Format (ä¸¥æ ¼éµå¾ªä»¥ä¸‹ Markdown ç»“æ„)
è¯·è¾“å‡ºæ’ç‰ˆç²¾ç¾çš„ Markdown æ ¼å¼ï¼Œå±‚çº§å¿…é¡»æ¸…æ™°ï¼š

## ğŸŒŸ æ ¸å¿ƒè¶‹åŠ¿é€Ÿé€’ (Executive Summary)
> ï¼ˆç”¨ä¸€æ®µè¯æ€»ç»“ä»Šå¤©è¿™æ‰¹æ•°æ®ä¸­åæ˜ å‡ºçš„æŠ€æœ¯é£å‘ã€‚ä¾‹å¦‚ï¼šâ€œä»Šå¤©çš„å¼€æºé¡¹ç›®ä¸»è¦é›†ä¸­åœ¨æå‡å·¥ä½œæµè‡ªåŠ¨åŒ–â€ï¼Œæˆ–â€œ.NET æ›´æ–°ä¾§é‡äºæ›´ä½å†…å­˜åˆ†é…çš„ä¼˜åŒ–â€ã€‚ï¼‰

## ğŸ“° .NET åº•å±‚ä¸æ¶æ„ç²¾é€‰
* **[æ–‡ç« /æ›´æ–°æ ‡é¢˜]**
  * ğŸ’¡ **ä¸€å¥è¯è§£é‡Š**ï¼š[å¤§ç™½è¯è¯´æ˜]
  * ğŸ¯ **è§£å†³ç—›ç‚¹**ï¼š[å®ƒä¸ºäº†è§£å†³ä»€ä¹ˆå¼€å‘/æ€§èƒ½ç—›ç‚¹è€Œç”Ÿï¼Ÿæœ‰ä½•æ”¶ç›Šï¼Ÿ]

## ğŸ¤– AI & Agent å‰æ²¿å·¥å…·
* **[é¡¹ç›®åç§°] - [Staræ•°]**
  * ğŸ’¡ **ä¸€å¥è¯è§£é‡Š**ï¼š[å¤§ç™½è¯è¯´æ˜]
  * ğŸ¯ **è§£å†³ç—›ç‚¹**ï¼š[ç›´å‡»ç—›ç‚¹ï¼Œå¦‚ï¼šæ›¿ä»£äº†æ‰‹åŠ¨çš„ API æ‹¼æ¥ï¼Œå®ç°äº†æœ¬åœ°åŒ–çš„ä»£ç è¡¥å…¨ç­‰]
  * âš¡ **å®æˆ˜åœºæ™¯**ï¼š[ç»™å‡º 1 ä¸ªå¯ä»¥è½åœ°çš„ä¸šåŠ¡åœºæ™¯]

## ğŸ® Unity ç‹¬ç«‹å¼€å‘åˆ©å™¨
* **[é¡¹ç›®åç§°] - [Staræ•°]**
  * ğŸ’¡ **ä¸€å¥è¯è§£é‡Š**ï¼š[å¤§ç™½è¯è¯´æ˜]
  * ğŸ¯ **è§£å†³ç—›ç‚¹**ï¼š[å¦‚ï¼šè§£å†³äº† Editor æ‰©å±•éš¾å†™ã€Asset æ‰“åŒ…æ…¢çš„é—®é¢˜]

---
# Input Data (ä»Šæ—¥æŠ“å–åŸå§‹æ•°æ®)"""

def generate_insight_report(date_str: str, dotnet_data: list, github_data: dict) -> str:
    """
    è°ƒç”¨ LLM æ ¹æ®æŠ“å–çš„æ•°æ®ç”Ÿæˆæ´å¯ŸæŠ¥å‘Šã€‚

    Args:
        date_str: æŠ¥å‘Šæ—¥æœŸ
        dotnet_data: .NET æ–‡ç« åˆ—è¡¨
        github_data: GitHub ä»“åº“ä¿¡æ¯ï¼ˆåŒ…å« readmeï¼‰
        
    Returns:
        LLM ç”Ÿæˆçš„ Markdown å­—ç¬¦ä¸²ã€‚è‹¥å¤±è´¥åˆ™è¿”å›ç©ºå­—ç¬¦ä¸²ã€‚
    """
    api_key = os.getenv("LLM_API_KEY")
    api_base = os.getenv("LLM_API_BASE", "https://api.openai.com/v1")
    model_name = os.getenv("LLM_MODEL", "gpt-4o")

    # åˆ¤æ–­æ˜¯å¦é…ç½®äº† API Key
    if not api_key or api_key == "your_llm_api_key_here":
        logger.warning("æœªé…ç½®çœŸå®çš„ LLM_API_KEYï¼Œå°†è·³è¿‡ AI ç”Ÿæˆæ­¥éª¤ã€‚")
        return ""

    try:
        client = OpenAI(api_key=api_key, base_url=api_base)
        
        # å°†æ•°æ®ç»„è£…ä¸º JSON å‘ç»™ LLM
        input_data = {
            "date": date_str,
            "dotnet_articles": dotnet_data,
            "github_trending": github_data
        }
        user_content = json.dumps(input_data, ensure_ascii=False, indent=2)

        logger.info(f"æ­£åœ¨è°ƒç”¨ LLM ({model_name}) ç”ŸæˆæŠ€æœ¯æŠ¥å‘Šï¼Œè¯·è€å¿ƒç­‰å¾…...")

        response = client.chat.completions.create(
            model=model_name,
            messages=[
                {"role": "system", "content": SYSTEM_PROMPT},
                {"role": "user", "content": f"ä»¥ä¸‹æ˜¯ {date_str} çš„æŠ“å–æ•°æ®ï¼š\n{user_content}"},
            ],
            temperature=0.7,
            # è®¾ç½®ä¸€ä¸ªåˆç†çš„è¾ƒé•¿ tokenï¼Œå¦‚æœä½¿ç”¨ DeepSeekã€GPT-4o ç­‰ï¼Œå†…å®¹ä¸ä¼šè¢«æˆªæ–­
            max_tokens=4000 
        )
        
        reply = response.choices[0].message.content.strip()
        return reply

    except Exception as e:
        logger.error(f"è°ƒç”¨ LLM ç”ŸæˆæŠ¥å‘Šæ—¶å‘ç”Ÿé”™è¯¯: {e}")
        return ""
